"use strict";!function(){function n(n){a={qiniuRegion:"",qiniuImageURLPrefix:"",qiniuUploadToken:"",qiniuUploadTokenURL:"",qiniuUploadTokenFunction:null,qiniuShouldUseQiniuFileName:!1},i(n)}function i(n){n.region?a.qiniuRegion=n.region:console.error("qiniu uploader need your bucket region"),n.uptoken?a.qiniuUploadToken=n.uptoken:n.uptokenURL?a.qiniuUploadTokenURL=n.uptokenURL:n.uptokenFunc&&(a.qiniuUploadTokenFunction=n.uptokenFunc),n.domain&&(a.qiniuImageURLPrefix=n.domain),a.qiniuShouldUseQiniuFileName=n.shouldUseQiniuFileName}function e(n,e,l,r,t,p,c,s){if(null==n)return void console.error("qiniu uploader need filePath to upload");if(r&&i(r),a.qiniuUploadToken)o(n,e,l,r,t,p,c,s);else if(a.qiniuUploadTokenURL)u(function(){o(n,e,l,r,t,p,c,s)});else{if(!a.qiniuUploadTokenFunction)return void console.error("qiniu uploader need one of [uptoken, uptokenURL, uptokenFunc]");if(a.qiniuUploadToken=a.qiniuUploadTokenFunction(),null==a.qiniuUploadToken&&a.qiniuUploadToken.length>0)return void console.error("qiniu UploadTokenFunction result is null, please check the return value");o(n,e,l,r,t,p,c,s)}}function o(n,i,e,o,u,r,t,p){if(null==a.qiniuUploadToken&&a.qiniuUploadToken.length>0)return void console.error("qiniu UploadToken is null, please check the init config or networking");var c=l(a.qiniuRegion),s=n.split("//")[1];o&&o.key&&(s=o.key);var k={token:a.qiniuUploadToken};a.qiniuShouldUseQiniuFileName||(k.key=s),t&&t();var d=wx.uploadFile({url:c,filePath:n,name:"file",formData:k,success:function(n){var o=n.data;try{var u=JSON.parse(o),l=a.qiniuImageURLPrefix+"/"+u.key;u.fileUrl=l,u.imageURL=l,console.log(u),i&&i(u)}catch(n){console.log("parse JSON failed, origin String is: "+o),e&&e(n)}},fail:function(n){console.error(n),e&&e(n)},complete:function(n){p&&p(n)}});d.onProgressUpdate(function(n){u&&u(n)}),r&&r(function(){d.abort()})}function u(n){wx.request({url:a.qiniuUploadTokenURL,success:function(i){var e=i.data.uptoken;e&&e.length>0?(a.qiniuUploadToken=e,n&&n()):console.error("qiniuUploader cannot get your token, please check the uptokenURL or server")},fail:function(n){console.error("qiniu UploadToken is null, please check the init config or networking: "+n)}})}function l(n){var i=null;switch(n){case"ECN":i="https://up.qiniup.com";break;case"NCN":i="https://up-z1.qiniup.com";break;case"SCN":i="https://up-z2.qiniup.com";break;case"NA":i="https://up-na0.qiniup.com";break;case"ASG":i="https://up-as0.qiniup.com";break;default:console.error("please make the region is with one of [ECN, SCN, NCN, NA, ASG]")}return i}var a={qiniuRegion:"",qiniuImageURLPrefix:"",qiniuUploadToken:"",qiniuUploadTokenURL:"",qiniuUploadTokenFunction:null,qiniuShouldUseQiniuFileName:!1};module.exports={init:n,upload:e}}();